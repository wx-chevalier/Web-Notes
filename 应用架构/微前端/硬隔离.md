# æµè§ˆå™¨ç¡¬éš”ç¦»

ç»„åˆä¸éš”ç¦»ï¼Œæœ¬å°±æ˜¯ä¸€ä½“ä¸¤é¢ï¼Œå¾€å¾€æŸç§ç»„åˆæ–¹æ¡ˆå°±è‡ªç„¶è§£å†³äº†éš”ç¦»çš„ç—›ç‚¹ï¼Œè€ŒæŸç§éš”ç¦»æ–¹æ¡ˆåˆä¼šé™åˆ¶ç»„åˆçš„æ–¹å¼ã€‚ç¬”è€…é¦–å…ˆä»ç¡¬/è½¯éš”ç¦»çš„è§’åº¦æ¥å¯¹æ–¹æ¡ˆè¿›è¡Œåˆ†ç±»ï¼ŒæœåŠ¡ç«¯è·¯ç”±åˆ†å‘ä¸ iFrame æ˜¯å…¸å‹çš„åŸºäºæµè§ˆå™¨çš„ç¡¬éš”ç¦»æ–¹æ¡ˆï¼Œå…¶å¤©ç„¶æ”¯æŒå¤šæŠ€æœ¯æ ˆã€å¤šæºçš„çµæ´»ç»„åˆï¼Œä¸è¿‡å…¶åœ¨åº”ç”¨åè°ƒä¸æ²»ç†æ–¹é¢éœ€è¦æŠ•å…¥è¾ƒå¤§çš„ç²¾åŠ›ã€‚Web Components åŠå…¶è¡ç”Ÿæ–¹æ¡ˆåŒæ ·èƒ½å¸¦æ¥æµè§ˆå™¨çº§åˆ«çš„éš”ç¦»ä¸æ¾æ•£çš„åº”ç”¨åè°ƒï¼Œä½†æ˜¯è¾ƒå·®çš„æµè§ˆå™¨å…¼å®¹æ€§ä¹Ÿé™åˆ¶äº†å…¶åº”ç”¨åœºæ™¯ã€‚

## iFrame

iFrame å¯ä»¥åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ç‹¬ç«‹çš„å®¿ä¸»ç¯å¢ƒï¼ŒiFrame çš„é¡µé¢å’Œçˆ¶é¡µé¢æ˜¯åˆ†å¼€çš„ï¼Œä½œä¸ºç‹¬ç«‹åŒºåŸŸè€Œä¸å—çˆ¶é¡µé¢çš„ CSS æˆ–è€…å…¨å±€çš„ JavaScript å½±å“ã€‚iFrame çš„ä¸è¶³æˆ–ç¼ºé™·ä¹Ÿéå¸¸æ˜æ˜¾ï¼Œå…¶ä¼šè¿›è¡Œèµ„æºçš„é‡å¤åŠ è½½ï¼Œå ç”¨é¢å¤–çš„å†…å­˜ï¼›å…¶ä¼šé˜»å¡ä¸»é¡µé¢çš„ onload äº‹ä»¶ï¼Œå’Œä¸»é¡µé¢å…±äº«è¿æ¥æ± ï¼Œè€Œæµè§ˆå™¨å¯¹ç›¸åŒåŸŸçš„è¿æ¥æœ‰é™åˆ¶ï¼Œæ‰€ä»¥ä¼šå½±å“é¡µé¢çš„å¹¶è¡ŒåŠ è½½ã€‚

iFrame çš„æ”¹é€ é—¨æ§›è¾ƒä½ï¼Œä½†æ˜¯ä»åŠŸèƒ½éœ€æ±‚çš„è§’åº¦çœ‹ï¼Œå…¶æ— æ³•æä¾› SEOï¼Œå¹¶ä¸”éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰åº”ç”¨ç®¡ç†ä¸åº”ç”¨é€šè®¯æœºåˆ¶ã€‚iFrame çš„åº”ç”¨ç®¡ç†ä¸ä»…è¦å…³æ³¨å…¶åŠ è½½ä¸ç”Ÿå‘½å‘¨æœŸï¼Œè¿˜éœ€è¦è€ƒè™‘åˆ°æµè§ˆå™¨ç¼©æ”¾ç­‰åœºæ™¯ä¸‹çš„ç•Œé¢é‡é€‚é…é—®é¢˜ï¼Œä»¥æä¾›ç”¨æˆ·ä¸€è‡´çš„äº¤äº’ä½“éªŒï¼›è¿™é‡Œæˆ‘ä»¬å†ç®€è¦è®¨è®ºä¸‹åŒæºåœºæ™¯ä¸­çš„è·¨ç•Œé¢é€šè®¯è§£å†³æ–¹æ¡ˆã€‚

> ğŸ“– è¯¦ç»†è§£è¯»å‚é˜… [DOM CheatSheet](https://parg.co/YlB)

- BroadcastChannel

BroadcastChannel èƒ½å¤Ÿç”¨äºåŒæºä¸åŒé¡µé¢ä¹‹é—´å®Œæˆé€šä¿¡çš„åŠŸèƒ½ã€‚å®ƒä¸ window.postMessage çš„åŒºåˆ«å°±æ˜¯ï¼ŒBroadcastChannel åªèƒ½ç”¨äºåŒæºçš„é¡µé¢ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œè€Œ window.postMessage å´å¯ä»¥ç”¨äºä»»ä½•çš„é¡µé¢ä¹‹é—´ï¼›BroadcastChannel å¯ä»¥è®¤ä¸ºæ˜¯ window.postMessage çš„ä¸€ä¸ªå®ä¾‹ï¼Œå®ƒæ‰¿æ‹…äº† window.postMessage çš„ä¸€ä¸ªæ–¹é¢çš„åŠŸèƒ½ã€‚

```js
const channel = new BroadcastChannel("channel-name");

channel.postMessage("some message");
channel.postMessage({ key: "value" });

channel.onmessage = function (e) {
  const message = e.data;
};

channel.close();
```

- SharedWorker API

Shared Worker ç±»ä¼¼äº Web Workersï¼Œä¸è¿‡å…¶ä¼šè¢«æ¥è‡ªåŒæºçš„ä¸åŒæµè§ˆä¸Šä¸‹æ–‡é—´å…±äº«ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨ä½œæ¶ˆæ¯çš„ä¸­è½¬ç«™ã€‚

```js
// main.js
const worker = new SharedWorker("shared-worker.js");

worker.port.postMessage("some message");

worker.port.onmessage = function (e) {
  const message = e.data;
};

// shared-worker.js
const connections = [];

onconnect = function (e) {
  const port = e.ports[0];
  connections.push(port);
};

onmessage = function (e) {
  connections.forEach(function (connection) {
    if (connection !== port) {
      connection.postMessage(e.data);
    }
  });
};
```

- Local Storage

localStorage æ˜¯å¸¸è§çš„æŒä¹…åŒ–åŒæºå­˜å‚¨æœºåˆ¶ï¼Œå…¶ä¼šåœ¨å†…å®¹å˜åŒ–æ—¶è§¦å‘äº‹ä»¶ï¼Œä¹Ÿå°±å¯ä»¥ç”¨ä½œåŒæºç•Œé¢çš„æ•°æ®é€šä¿¡ã€‚

```js
localStorage.setItem("key", "value");

window.onstorage = function (e) {
  const message = e.newValue; // previous value at e.oldValue
};
```

## Web Components && Shadow DOM

Web Components çš„ç›®æ ‡æ˜¯å‡å°‘å•é¡µåº”ç”¨ä¸­éš”ç¦» HTMLï¼ŒCSS ä¸ JavaScript çš„å¤æ‚åº¦ï¼Œå…¶ä¸»è¦åŒ…å«äº† Custom Elements, Shadow DOM, Template Elementï¼ŒHTML Importsï¼ŒCustom Properties ç­‰å¤šä¸ªç»´åº¦çš„è§„èŒƒä¸å®ç°ã€‚Shadow DOM å®ƒå…è®¸åœ¨æ–‡æ¡£ï¼ˆdocumentï¼‰æ¸²æŸ“æ—¶æ’å…¥ä¸€æ£µ DOM å…ƒç´ å­æ ‘ï¼Œä½†æ˜¯è¿™æ£µå­æ ‘ä¸åœ¨ä¸» DOM æ ‘ä¸­ã€‚å› æ­¤å¼€å‘è€…å¯åˆ©ç”¨ Shadow DOM å°è£…è‡ªå·±çš„ HTML æ ‡ç­¾ã€CSS æ ·å¼å’Œ JavaScript ä»£ç ã€‚å­æ ‘ä¹‹é—´å¯ä»¥ç›¸äº’åµŒå¥—ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹è¿›è¡Œäº†å°è£…ï¼Œæœ‰é€‰æ‹©æ€§çš„è¿›è¡Œæ¸²æŸ“ã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ’å…¥æ–‡æœ¬ã€é‡æ–°å®‰æ’å†…å®¹ã€æ·»åŠ æ ·å¼ç­‰ç­‰ã€‚å…¶ç»“æ„ç¤ºæ„å¦‚ä¸‹ï¼š

![image](https://user-images.githubusercontent.com/5803001/43813782-c17e5d34-9af9-11e8-94df-7974298a2afc.png)

ç®€å•çš„ Shadow DOM åˆ›å»ºæ–¹å¼å¦‚ä¸‹ï¼š

```html
<html>
  <head></head>
  <body>
    <p id="hostElement"></p>
    <script>
      // åˆ›å»º shadow DOM
      var shadow = document
        .querySelector("#hostElement")
        .attachShadow({ mode: "open" });
      // ç»™ shadow DOM æ·»åŠ æ–‡å­—
      shadow.innerHTML = "<p>Here is some new text</p>";
      // æ·»åŠ CSSï¼Œå°†æ–‡å­—å˜çº¢
      shadow.innerHTML += "<style>p { color: red; }</style>";
    </script>
  </body>
</html>
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥å°† React åº”ç”¨å°è£…ä¸º Custom Element å¹¶ä¸”å°è£…åˆ° Shadow DOM ä¸­ï¼š

```js
import React from "react";
import retargetEvents from "react-shadow-dom-retarget-events";

class App extends React.Component {
  render() {
    return <div onClick={() => alert("I have been clicked")}>Click me</div>;
  }
}

const proto = Object.create(HTMLElement.prototype, {
  attachedCallback: {
    value: function () {
      const mountPoint = document.createElement("span");
      const shadowRoot = this.createShadowRoot();
      shadowRoot.appendChild(mountPoint);
      ReactDOM.render(<App />, mountPoint);
      retargetEvents(shadowRoot);
    },
  },
});
document.registerElement("my-custom-element", { prototype: proto });
```

Shadow DOM çš„å…¼å®¹æ€§è¾ƒå·®ï¼Œä»…åœ¨ Chrome è¾ƒé«˜ç‰ˆæœ¬æµè§ˆå™¨ä¸­å¯ä»¥ä½¿ç”¨ã€‚
